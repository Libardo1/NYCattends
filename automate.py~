#/usr/bin/env python

import os
os.chdir("/home/aaron/NYCattends")

from subprocess import call
call("curl http://schools.nyc.gov/aboutus/data/attendancexml/ -o temp.xml", shell=True)

with open('temp.xml') as f:
  content = f.readline()

import re
then = re.search("[0-9]{8}", content).group(0)

from datetime import date
today = date.strftime(date.today(), format="%Y%m%d")
import time
day = time.strftime("%A")

import os.path
if not os.path.exists(then + '.xml'):
  first = True
  call("git pull", shell=True)
  call("mv temp.xml " + then + '.xml', shell=True)
  call("git add .", shell=True)
  call("git commit -am 'auto-update for " + today  + "'", shell=True)
  call("git push", shell=True)

percent = re.search('<ATTN_PCT>([0-9]+\.[0-9]+)</ATTN_PCT><LOC_CODE></LOC_CODE><SCHOOL_NAME>CITYWIDE TOTAL', content).group(1)

from random import choice
tags = ['@NYCSchools',
        '#NYC',
        '@GothamSchools',
        '@innovateNYCedu',
        '#eddata',
        '#EdTechNYC',
        '@Ed4Excellence',
        '@usedgov',
        '@attendanceworks',
        '#edchat']
tag = choice(tags)

links = ['bit.ly/NYCattends',
         'bit.ly/NYCattdarch']
link = choice(links)

claims = ['NYC public school attendance for today was ' + percent + '%.',
          percent + '% of NYC public school students were in school today.',
          'On this fine ' + day + ', ' + percent + '% of NYC public school students were in school.',
          day + "'s NYC public school attendance: " + percent + '%']
claim = choice(claims)

tweet_text = claim + ' ' + link + ' ' + tag

if float(percent) < 70:
  tweet_text = "The NYCDOE reported " + percent + "% attendance for " + day + ". " + link

import tweetpony
if today == then and first:
  api = tweetpony.API(consumer_key="AQ3KQKnjBbb8U6cAdG8miw", consumer_secret="GTnZ8MC8613LZxaOcKNHXtVUux3REwSw9DM2OdUf0", access_token="1279320223-PKZplU9paz0wqPNkQKhyBXs0FuEZtozrigJ7hAa", access_token_secret="4umvrnNjLKd4KW5zuTsLBIo6mBqFVCsPGVpXk4gWkI")
  api.update_status(status=tweet_text)
